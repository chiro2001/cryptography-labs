## 实验二 RSA 密码算法

> 姓名：梁鑫嵘；学号：200110619

### 运行截图

因为截图不太好排版所以就直接贴出结果了。静态可执行程序在 `release` 文件夹，其他可执行程序在 `build/linux/x86_64/release` 文件夹。

**程序参数**

```sh
$ ./rsa -h                                                                                 
Usage: rsa [OPTIONS]

Options:
  -m, --mode <MODE>            Run mode [default: generate] [possible values: generate, encode, decode, test]
  -k, --key <KEY>              Key path, generate/detect `path' and `path.pub' [default: data/rsa]
  -c, --comment <COMMENT>      Attach comment to key files [default: "RSA-RS COMMENT"]
      --binary                 Output key in base64 format
  -i, --input <INPUT>          Input filename [default: stdin]
  -o, --output <OUTPUT>        Output filename [default: stdout]
      --prime-min <PRIME_MIN>  Min prime bits [default: 14]
      --prime-max <PRIME_MAX>  Max prime bits [default: 512]
  -r, --rounds <ROUNDS>        Miller Rabin calculate rounds [default: 10]
      --time-max <TIME_MAX>    Max time in mill seconds that trying to generate a prime [default: 1000]
  -s, --silent                 Disable log output
      --retry                  Retry when failed to generate primes
  -t, --threads <THREADS>      Calculate in <THREADS> threads [default: 20]
  -h, --help                   Print help information
$ 
```

**密钥生成**

使用 20 线程，生成 2048 位 RSA 密钥对，耗时约 3~10 秒。

```sh
$ ./rsa -m generate --prime-min 1024 --prime-max 2048 --retry -c "Sample RSA Key" -k key
Run args: RSA { mode: "generate", key: "key", comment: "Sample RSA Key", binary: false, input: "stdin", output: "stdout", prime_min: 1024, prime_max: 2048, rounds: 10, time_max: 1000, silent: false, retry: true, threads: 20 }
Failed generation in 105 tries after 1002 ms
Failed generation in 120 tries after 1010 ms
Failed generation in 90 tries after 1014 ms
Failed generation in 105 tries after 1014 ms
# more logs
Failed generation in 120 tries after 1016 ms
Failed generation in 75 tries after 1032 ms
Failed generation in 135 tries after 1133 ms
Done generation in 75 tries after 1133 ms
Use cached prime: 1547043217042542386582369055167400032122230108706427866356368387836762927248873775881323957
0398328388639015807559762488292899167903729861163899553085662587205606227440267770166516248
4233907147963314573729394512658671222493541219092612117874305453583331460701088580038378816
7255781202688253509767462491478664951940244138158620569073362977019858271553512654284189481
9679940408861931680499459812342838143893894668051297532672260997707841760875217089022687699
7704896351210698496367737801618379445345591194353922458144178419601082167426920886427750810
41559953203396668117631929954259768092668666696685351357549053006787377
Use cached prime: 1349228588247922500187127576657928893609153590154985481120571952870065723509938946577086314
8424766498884898700861888377070342341547244303052122801021487108037190124902601104121421629
9730771344270933729219257889917055053095354197639769148085428166365291176058559472126807655
7244268099858625061502454951786071655520670007393425498963452045552897230218581931146905504
7796527770623076829306062113700915771323515882488092576497782635164042045519699027547544001
6425200293828295788419363954067144636576839549262028405929063134151085640775692526117938547
41906708592925515376207800041191819936178163130377682375919321426622077
(d * e) % f = 
5853511642032934628744980320792898808272858028548448527070170731608356639225200314990119868
0437972502368232568386261944822260514297365954814662635572550530796381869553572866932214358
2263567892320817653422748220390112491041828936445278038948075703800951118766031551870348883
0499139929401055844483547969498734976793618270088287119820269195667022164451684139428322283
9878473510249107213154146679766713393431487128274346586236972659717895377885731181312000149
0642184060978694128136125778727626968370359105800451200773485061785315473740636785558625419
3913746591559583503783664536796229843519674332302468092273418189284596529620989301296037688
0796993800432943976741942621161730880963189901191825108475954020472651775298994700711743561
2006597281971409561858132674206906138714674604344796009532904458365917075574523249518249402
9403578328376591909464684955062817307097698640768995923211085037353787191104178689793598655
1434204773634494630075134667701214443158251582782154489998242131804087755224118332682080625
0026340355146435158261186270023850317507277793923425494280362583735583371910909881407957660
4184371353355288505561632691722583155303254849337011203861767839361696689526191866103850572
6019150757338050565380733824964878868923229370262822257479975216176327124675537649468976392
2969009151759388317227081780985198278642439836817343935398222783921096188283836343795998047
0667497984210436155528325845145355682732319675455633832559633119797312035965881757720721979
5982774658693712090855169659387531509928624758854616882879321304049790177342422973498272225
1741589696626506781296633155807728107118116428937098736776722021273311441829992317138855433
9968040538260995463459052771333756396540361890529271357875304660319104514625236342155777234
5816024079476770829853428645834883094749545007662456138570703484231175947265924856347213258
2442255378024922231114649601 % 
1049995407349478187591602244373721405392888648060006679099453353337487569126088370074034833
9243397340630964750442815451387922791560361327362871923956760466019593767959679495524411378
3333962452400672981104071491238390911392905418965039410137725412916818792962611582950158945
6774527481261687069923934517043255626558740393617119218385065073168607294503161040081236119
0519948648871773411154075090132831074511443342382251918462329181368114206141830154169730569
0783503506393928617304895971765389028362712951991597477404785653258987667894452632373271279
1834778282180979695642235463859184083265383610007240009892700902434172353326173235163036566
5222544488526660114302539340744983086440236636410780621897425591679476750488891188501696926
6109317492140841664427170046823519065024888352395728041589342117504777279702662016490953346
5091098573595797384104329335014874323809822361364794307765059877142614479650590160689897931
9142324438613085940282946614892457904495501812056321280727661251265620133842462735651067866
3404653906345017929986157586061958298629245120634625080614122325429252644169635310163579562
6340016023599547695345861832157571230175830833327310835964762036346297283311452000508043371
17625609202198548328840628146502651381073906971008 = 1
get key_pair: KeyPair { public: KeyData { mode: "PUBLIC_", comment: "Sample RSA Key", key: Key { base: 
1349228588247922500187127576657928893609153590154985481120571952870065723509938946577086314
8424766498884898700861888377070342341547244303052122801021487108037190124902601104121421629
9730771344270933729219257889917055053095354197639769148085428166365291176058559472126807655
7244268099858625061502454951786071655520670007393425498963452045552897230218581931146905504
7796527770623076829306062113700915771323515882488092576497782635164042045519699027547544001
6425200293828295788419363954067144636576839549262028405929063134151085640775692526117938547
41906708592925515376207800041191819936178163130377682375919321426622077, m: 
1049995407349478187591602244373721405392888648060006679099453353337487569126088370074034833
9243397340630964750442815451387922791560361327362871923956760466019593767959679495524411378
3333962452400672981104071491238390911392905418965039410137725412916818792962611582950158945
6774527481261687069923934517043255626558740393617119218385065073168607294503161040081236119
0519948648871773411154075090132831074511443342382251918462329181368114206141830154169730569
0783503506393928617304895971765389028362712951991597477404785653258987667894452632373271279
1834778282180979695642235463859184083265383610007240009892700902434172575901605182655179385
6600569462949116555372643393529742703629665291371987866717543149001779200199606466278386422
8758633754943829075241904469446130638887015646557035337359586187853057883134037311054196650
9389573653684675551185662114906354842882836273983153722705000385868265293711946589986317776
5458929341324030941762908337687577933712382899940814316287855868657620672183804936268591306
3672666212917112254987149592867172921081697607125458892674243289115212402896747350490140386
5233745218125099460615547038048827412933417886007903872278219210666521840180615831192512737
60758272952767925604299985180780956543176400430393 }, 
header: "-----BEGIN RSA-2048 PUBLIC_ KEY-----", footer: "-----END RSA-2048 PUBLIC_ KEY-----" }, private: KeyData { mode: "PRIVATE", comment: "Sample RSA Key", key: Key { base: 
4338413589082166916621781491589593841162859863208853401659239557844066354977376209113395826
6736365102762535933206469668936832684357615672242583369371440079512808249591989053613935978
6884144570349829485035363237550600334278533091567080762365604674710171865740026148765192360
4911461576109871956808875219890807382796864234923323280125741391022968427135368846247485830
8811107529362473348494566823485654285826290846414150676748174432343980927335314272028602247
7032183021547142257745534467230333338692470406943441978810753909500889420047073489432427939
4236499146276016254987131111155811630224136014282892496276648320023829281441789410549308400
5984672968072803294909581818130322796822163166368137649729445297021776175484502966800956431
9187030872115874592138563365313758629563469683993892072282937853008566809482735174226425061
0168487921159089569638725843080672672982586250444873174359831121904108252386244212732880180
5224615217293818314556970809094228596837768208418084669605231200172033628275379809665423577
0017247916311627019981327364530323566376820033201438181143444108272098306803767099305323544
1733839957119949197116946316432167889771737769461632957469298935550354487328818923655998469
8556462583162307695278310549904090322856490713813, m: 
1049995407349478187591602244373721405392888648060006679099453353337487569126088370074034833
9243397340630964750442815451387922791560361327362871923956760466019593767959679495524411378
3333962452400672981104071491238390911392905418965039410137725412916818792962611582950158945
6774527481261687069923934517043255626558740393617119218385065073168607294503161040081236119
0519948648871773411154075090132831074511443342382251918462329181368114206141830154169730569
0783503506393928617304895971765389028362712951991597477404785653258987667894452632373271279
1834778282180979695642235463859184083265383610007240009892700902434172575901605182655179385
6600569462949116555372643393529742703629665291371987866717543149001779200199606466278386422
8758633754943829075241904469446130638887015646557035337359586187853057883134037311054196650
9389573653684675551185662114906354842882836273983153722705000385868265293711946589986317776
5458929341324030941762908337687577933712382899940814316287855868657620672183804936268591306
3672666212917112254987149592867172921081697607125458892674243289115212402896747350490140386
5233745218125099460615547038048827412933417886007903872278219210666521840180615831192512737
60758272952767925604299985180780956543176400430393 }, 
header: "-----BEGIN RSA-2048 PRIVATE KEY-----", footer: "-----END RSA-2048 PRIVATE KEY-----" } }
Generated key files: key, key.pub
```

**生成的密钥**

公钥：`key.pub`

```
-----BEGIN RSA-2048 PUBLIC_ KEY-----
AAEAAAACAAB99t5VNhqZEZojq/hqJ6twFfEzsuMNKupTR49ZDyknMLG7pSBFc7oIqpXDtX
gAP7XFyfSL6QkKnhDONmGNK4jB9nLm0mc3sxhBfddjv5cNF9iQGrvxrgaZRFNfQfDCPdZA
anK5dYwEAZHMPKijUuWaumw3VkJFGYySnq/CHHtwaGv625zdcLMeTCshISfCUdiy+wNqW+
KlMX23zrEJFVemafbo+6YdF8c8ibrxx5w0Wux2v/sC6p2X27TQTjNf6rRTlJoe/tQ+E/ho
P/cViH1MzpxnbJ/G9Koi6nczJ6rwdhM2psUPxpsedcgHM8xz0tr7g6sKPGzLUJyGmipgJu
FqOeXbb6r3E/6Dku4ImF0PwmTHZL+tAjeYi+m6IaMUuESjl2tISlRHpgPro6fO2ppHcC0U
XY1sTpiDiT7qe5SmOgFonSnB2YFsFCkiPo/PS0uoLzlJjb/dkzeL9NTf+UCSSSNZ/9uXoy
U60XOYFSXFDI+0bb9Kb3pwF7rRyU24ARG3kM9XO/1zHn0t8HQGGpuqSJggOdl9lKIV/Ley
SDFEjRykcmGpHA9UyIchVUtEhLyV9ki/4PFiJ8D+n/sEhrxHCw9v4dEf4qI6fJe/89xPsy
WrZJNEnFW02TC7uR0kfUHYYMxgJZIOqyL4P6CUD6Z43q3xgsIMt0ZvhXOGkqsd5AtPIhiM
uu0JhLRLMjkBnaGofcRlv4UUSTroS5h24R1Cek8gcMJZozpNxcgydEWkappZTtwqFuJ9rD
Fanm4uFWSUQjnWZjNlwN7qiyWGDaWvcyoIATdGowPZe2c9cRHlJ3o9zFCmiWwneQqv7jNZ
YJa9fH7l/NplnHzFgtU512fBl99TVBXsgBqBDTFsfIzi8ewPxwg74kk48VBsAT3Ra7LxyR
cmrU76O8Y8lRtYIm5oa929kRgdnML94g/owxTjfiidYPi9kRIX99JlL3konrZpC/01j+v5
VFfKnQQM9QIAZnyYYAi95CcEq1XElAB22HuybPrux4/rzVoWYgHIvBlQVUJMSUNfU2FtcG
xlIFJTQSBL
-----END RSA-2048 PUBLIC_ KEY-----
```

私钥：`key`

```
-----BEGIN RSA-2048 PRIVATE KEY-----
AAIAAAACAADVQnr8XNM6EW+3+cTw2/lLDYaWFT0GXcwzBardtwDwrXqlfFeV5YaWNvNdnC
HS9S6ovxBLwoKsO0HfhU9mBDkrtamhNmCd9BufUejv21+Hhr8RyID92DiWllbF6wCFhOVN
Vcgo7M031dt4QZ3QrwamkCynbiFq3p/bJsXjTdSaPxVdDOlMK9ewFnUkyfZc7bJr7L/qpo
DDWwzgYFz35YdbkXNO9zu8CslQAsK3WKVTxGBzR9hx/NGxwwaXDNIS7y5YhiiRybjfxx/0
uppO9PaZbd/VXFLUrcV8OliPw014PLHnUnyex10UfoxeVVUO2ej4wqEoXA4XGEQcWeYDaE
bBKuBOVPFXg2bhPl3TKHx3VZYvRt8dRzOOpE53laFDdN5gQQdFGyIJtP9A0uKeCWrUAyDA
DOgixp4SNgwknGcJlmqXom5yD7S25jea3xq61fll/DFrCkSGjQkf4H/83SY3jogr9/WrjD
GT5Lc1hiGUuOdZ1bJHQq3zSoPKfdvOTxYOxkP1DWysKrcUlz2DM+//HGIX9HA3tC60rAL9
elCW3g+E8SqYIf4eM5yxXNe55e2Ps6WICXwPZbDgnEvIwZYJR+7QuR5RCFmepA86fyHV9k
KbmaVopISHfK57JsVbMrHaHapCUGrFmRpOlp2ECQWxD1AMe3tF1VDkJwtvHWGiCjnl22+q
9xP+g5LuCJhdD8Jkx2S/rQI3mIvpuiGjFLhEo5drSEpUR6YD66OnztqaR3AtFF2NbE6Yg4
k+6nuUpjoBaJ0pwdmBbBQpIj6Pz0tLqC85SY2/3ZM3i/TU3/lAkkkjWf/bl6MlOtFzmBUl
xQyPtG2/Sm96cBe60clNuAERt5DPVzv9cx59LfB0BhqbqkiYIDnZfZSiFfy3skgxRI0cpH
JhqRwPVMiHIVVLRIS8lfZIv+DxYifA/p/7BIa8RwsPb+HRH+KiOnyXv/PcT7Mlq2STRJxV
tNkwu7kdJH1B2GDMYCWSDqsi+D+glA+meN6t8YLCDLdGb4VzhpKrHeQLTyIYjLrtCYS0Sz
I5AZ2hqH3EZb+FFEk66EuYduEdQnpPIHDCWaM6TcXIMnRFpGqaWU7cKhbifawxWp5uLhVk
lEI51mYzZcDe6oslhg2lr3MqCAE3RqMD2XtnPXER5Sd6PcxQpolsJ3kKr+4zWWCWvXx+5f
zaZZx8xYLVOddnwZffU1QV7IAagQ0xbHyM4vHsD8cIO+JJOPFQbAE90Wuy8ckXJq1O+jvG
PJUbWCJuaGvdvZEYHZzC/eIP6MMU434onWD4vZESF/fSZS95KJ62aQv9NY/r+VRXyp0EDP
UCAGZ8mGAIveQnBKtVxJQAdth7smz67seP681aFmIByLwZUFJJVkFURVNhbXBsZSBSU0Eg
S2V5
-----END RSA-2048 PRIVATE KEY-----
```

**加密**

```sh
$ ./rsa -i rsa -o rsa.bin -k key -m encode 
Run args: RSA { mode: "encode", key: "key", comment: "RSA-RS COMMENT", binary: false, input: "rsa", output: "rsa.bin", prime_min: 14, prime_max: 512, rounds: 10, time_max: 1000, silent: false, retry: true, threads: 20 }
group size 256, input => output: 256 => 512
source chunk: 21226
  [00:01:13] [#############################################################] 5.18 MiB/5.18 MiB (0s)read filesize: 5433848, data filesize: 5433848 res chunk: 21226
Done
```

**解密**

```sh
$ ./rsa -o rsa2 -i rsa.bin -k key -m decode                                             
Run args: RSA { mode: "decode", key: "key", comment: "RSA-RS COMMENT", binary: false, input: "rsa.bin", output: "rsa2", prime_min: 14, prime_max: 512, rounds: 10, time_max: 1000, silent: false, retry: true, threads: 20 }
group size 512, input => output: 512 => 256
source chunk: 21226
  [00:02:26] [###########################################################] 10.36 MiB/10.36 MiB (0s)read filesize: 10867712, data filesize: 5433848 res chunk: 21226
Done
```

解密过后的文件与原文件完全相同。

```sh
$ diff rsa rsa2
$
```

**密钥测试**

将会输出密钥信息，并对随机数据进行加解密以判断密钥正确性。

```sh
$ ./rsa -k key -m test    
Run args: RSA { mode: "test", key: "key", comment: "RSA-RS COMMENT", binary: false, input: "stdin", output: "stdout", prime_min: 14, prime_max: 512, rounds: 10, time_max: 1000, silent: false, retry: true, threads: 20 }
PUBLIC_ key, comment: Sample RSA Key
PRIVATE key, comment: Sample RSA Key
start testing key pair
get key_pair: KeyPair { public: KeyData { mode: "PUBLIC_", comment: "Sample RSA Key", key: Key { base: 
13492285882479225001871275766579288936091535901549854811205719528700657235099389465770
86314842476649888489870086188837707034234154724430305212280102148710803719012490260110
41214216299730771344270933729219257889917055053095354197639769148085428166365291176058
55947212680765572442680998586250615024549517860716555206700073934254989634520455528972
30218581931146905504779652777062307682930606211370091577132351588248809257649778263516
40420455196990275475440016425200293828295788419363954067144636576839549262028405929063
13415108564077569252611793854741906708592925515376207800041191819936178163130377682375
919321426622077, m: 
10499954073494781875916022443737214053928886480600066790994533533374875691260883700740
34833924339734063096475044281545138792279156036132736287192395676046601959376795967949
55244113783333962452400672981104071491238390911392905418965039410137725412916818792962
61158295015894567745274812616870699239345170432556265587403936171192183850650731686072
94503161040081236119051994864887177341115407509013283107451144334238225191846232918136
81142061418301541697305690783503506393928617304895971765389028362712951991597477404785
65325898766789445263237327127918347782821809796956422354638591840832653836100072400098
92700902434172575901605182655179385660056946294911655537264339352974270362966529137198
78667175431490017792001996064662783864228758633754943829075241904469446130638887015646
55703533735958618785305788313403731105419665093895736536846755511856621149063548428828
36273983153722705000385868265293711946589986317776545892934132403094176290833768757793
37123828999408143162878558686576206721838049362685913063672666212917112254987149592867
17292108169760712545889267424328911521240289674735049014038652337452181250994606155470
38048827412933417886007903872278219210666521840180615831192512737607582729527679256042
99985180780956543176400430393 }, 
header: "-----BEGIN RSA-2048 PUBLIC_ KEY-----", footer: "-----END RSA-2048 PUBLIC_ KEY-----" }, private: KeyData { mode: "PRIVATE", comment: "Sample RSA Key", key: Key { base: 
43384135890821669166217814915895938411628598632088534016592395578440663549773762091133
95826673636510276253593320646966893683268435761567224258336937144007951280824959198905
36139359786884144570349829485035363237550600334278533091567080762365604674710171865740
02614876519236049114615761098719568088752198908073827968642349233232801257413910229684
27135368846247485830881110752936247334849456682348565428582629084641415067674817443234
39809273353142720286022477032183021547142257745534467230333338692470406943441978810753
90950088942004707348943242793942364991462760162549871311111558116302241360142828924962
76648320023829281441789410549308400598467296807280329490958181813032279682216316636813
76497294452970217761754845029668009564319187030872115874592138563365313758629563469683
99389207228293785300856680948273517422642506101684879211590895696387258430806726729825
86250444873174359831121904108252386244212732880180522461521729381831455697080909422859
68377682084180846696052312001720336282753798096654235770017247916311627019981327364530
32356637682003320143818114344410827209830680376709930532354417338399571199491971169463
16432167889771737769461632957469298935550354487328818923655998469855646258316230769527
8310549904090322856490713813, m: 
10499954073494781875916022443737214053928886480600066790994533533374875691260883700740
34833924339734063096475044281545138792279156036132736287192395676046601959376795967949
55244113783333962452400672981104071491238390911392905418965039410137725412916818792962
61158295015894567745274812616870699239345170432556265587403936171192183850650731686072
94503161040081236119051994864887177341115407509013283107451144334238225191846232918136
81142061418301541697305690783503506393928617304895971765389028362712951991597477404785
65325898766789445263237327127918347782821809796956422354638591840832653836100072400098
92700902434172575901605182655179385660056946294911655537264339352974270362966529137198
78667175431490017792001996064662783864228758633754943829075241904469446130638887015646
55703533735958618785305788313403731105419665093895736536846755511856621149063548428828
36273983153722705000385868265293711946589986317776545892934132403094176290833768757793
37123828999408143162878558686576206721838049362685913063672666212917112254987149592867
17292108169760712545889267424328911521240289674735049014038652337452181250994606155470
38048827412933417886007903872278219210666521840180615831192512737607582729527679256042
99985180780956543176400430393 },
header: "-----BEGIN RSA-2048 PRIVATE KEY-----", footer: "-----END RSA-2048 PRIVATE KEY-----" } }
  [00:03:29] [#########################################################] 250.00 KiB/250.00 KiB (0s)
Test pass
```

**通过管道对测试数据加解密**

上面的运行结果都是对一整个大的二进制文件（RSA 可执行程序本身）加解密，下面对实验给出的测试数据加解密。加密后的数据通过操作系统的管道向解密程序传递，最后解密后的结果输出到标准输出。

```sh
$ cat data/lab2-Plaintext.txt 
2002 A.M. TURING AWARD. RSA, an acronym for Rivest, Shamir and Adleman, uses algorithmic number theory to provide an efficient realization of a public-key cryptosystem, a concept first envisioned theoretically by Whitfield Diffie, Martin Hellman and Ralph Merkle. RSA is now the most widely used encryption method, with applications throughout the Internet to secure on-line transactions. It has also inspired breakthrough work in both theoretical computer science and mathematics.
$ ./target/release/rsa -i data/lab2-Plaintext.txt -k data/rsa -m encode | ./target/release/rsa -k data/rsa -m decode
2002 A.M. TURING AWARD. RSA, an acronym for Rivest, Shamir and Adleman, uses algorithmic number theory to provide an efficient realization of a public-key cryptosystem, a concept first envisioned theoretically by Whitfield Diffie, Martin Hellman and Ralph Merkle. RSA is now the most widely used encryption method, with applications throughout the Internet to secure on-line transactions. It has also inspired breakthrough work in both theoretical computer science and mathematics.
$ 
```

### 实验过程中遇到的问题有哪些？你是怎么解决的？

1. 如何使用大数字运算

   > 在本次实验中，本人使用了 Rust 的 `num-bigint` 开源大数运算库，在保证运算结果正确的同时拥有较好的性能。
   >
   > ```
   > num = "0.4.0"
   > num-bigint = { version = "0.4.3", features = ["rand"] }
   > num-traits = "0.2.15"
   > ```

2. 如何提高计算效率

   > 由于使用大数计算，当数字长度较长时性能可能难以保证。尽管使用了快速幂等方式加速运算但是还是难以满足需求，需要采用多线程并行等方式加速（ECB 模式）。在此基础上，使用线程池等也能加快计算速度。

3. 运行模式问题

   > 分组密码都可以使用 ECB / CBC 等模式加解密。考虑到本次使用的是大数运算，并且分组大小并不是固定的，所以使用 CBC 模式会比较麻烦，于是本实验仅实现了 ECB 模式。

### 请说明你的字符分组方式，以及关键的算法例如扩展欧几里德，素数检测，快速幂等

1. 字符分组方式

   > 本算法使用二进制加密，输入数据分组即将源文件切分为大小相同为 $k$ 的 $n$ 块，其中最后一块大小可以不足 $k$。为了防止溢出，本人直接设 $k < \frac{\log_2{K}}{2}$，$K$ 为密钥中 `m` 长度。
   >
   > 在上文的例子中，加密时 $k=256$，每组得到密文最大比特长度 $512$。
   >
   > 由于还是需要确定最后一个分组的末尾的 $0$ 字节的个数，所以还需要将文件大小写入加密后的文件内。本实验采用的做法是加密时将文件字节数写入加密后文件开头前 8 个字节，解密时读取加密后文件前 8 个字节并得到最后需要补充多少 $0$ 字节的信息。
   >
   > 同样以上文为例，解密时每次读取 $512$ 比特长度的密文并解密出 $256$ 比特的明文。

2. 扩展欧几里得算法

   > ```C
   > 	fn extended_euclid(a: &BigInt, b: &BigInt, x: &BigInt, y: &BigInt) -> (BigInt, BigInt, BigInt) {
   >         if b.is_zero() {
   >             return (a.clone(), 1.to_bigint().unwrap(), 0.to_bigint().unwrap());
   >         }
   >         let (d, x2, y2) = RSA::extended_euclid(b, &(a % b), y, x);
   >         return (d, y2.clone(), x2 - a / b * &y2);
   >     }
   > 
   >     pub fn mod_reverse(a: &BigInt, b: &BigInt) -> BigInt {
   >         let d = RSA::extended_euclid(a, b, &Zero::zero(), &One::one());
   >         if d.0.is_one() {
   >             (d.1 % b + b) % b
   >         } else {
   >             Zero::zero()
   >         }
   >     }
   > ```
   >
   > `extended_euclid` 函数为解出贝祖等式 $ax+by=gcd(a,b)=d$。
   >
   > `mod_reverse` 函数调用 `extended_euclid` 得到 $x, y, d$。因为解的是 $d\times e\equiv 1 \mod \varphi(n)$，`extended_euclid` 调用时 $a=e,b=\varphi(n)$ 返回 $x=1$，则 $d=y\equiv b$。

3. 快速幂

   > ```C
   >     pub fn fast_modular_exponent(mut a: BigInt, mut q: BigInt, n: BigInt) -> BigInt {
   >         let mut r: BigInt = One::one();
   >         while q != Zero::zero() {
   >             if q.bit(0) { r = (r * &a) % &n; }
   >             q >>= 1;
   >             a = (&a * &a) % &n;
   >         }
   >         r
   >     }
   > ```
   >
   > $$
   > a^q=a\times a\times a \cdots \times a \\
   > =(((a\times a)\times a)\times a)\times \cdots \\
   > =a^0\times a^1\times a^2\times a^4\times \cdots \\
   > =\prod^i a^i, (\sum^i i = q,i = 2^k)
   > $$
   >
   > 故可以每次让 $a\leftarrow a \times a$，当 $q$ 对应二进制位为 $1$ 的时候将当前结果与 $a$ 相乘。

4. 素性检测算法

   > ```C
   >     pub fn miller_rabin(n: &BigInt, rounds: u32) -> Result<bool, Box<dyn Error>> {
   >         if n.is_zero() { return Ok(true); }
   >         if !n.bit(0) || n.is_one() { return Ok(false); }
   >         let mut rng = rand::thread_rng();
   >         let mut d: BigInt = n - 1.to_bigint().unwrap();
   >         while d.bit(0) { d >>= 1; }
   >         let tmp = d.clone();
   >         for _ in 0..rounds {
   >             d = tmp.clone();
   >             let mut m = RSA::fast_modular_exponent(
   >                 rng.gen_biguint_range(&Zero::zero(), &((n - 2.to_bigint().unwrap()).to_biguint().unwrap())).to_bigint().unwrap() + 2.to_bigint().unwrap(),
   >                 d.clone(), n.clone());
   >             if m == One::one() { continue; } else {
   >                 let mut pass = false;
   >                 while d < *n {
   >                     if m == n - 1.to_bigint().unwrap() {
   >                         pass = true;
   >                         break;
   >                     }
   >                     m = (&m * &m) % n;
   >                     d <<= 1;
   >                 }
   >                 if !pass { return Ok(false); }
   >             }
   >         }
   >         Ok(true)
   >     }
   > ```
   >
   > 本实验采用 Miller Rabin 素性检测算法，大致思路为每次随机选取两个整数 $k, q$，再在 $(1,n-1)$ 范围内选择随机数 $a$：
   >
   > 1. 当 $a^q\equiv1\mod n$ 或者 $a^q\equiv n-1\mod n$，则很可能为素数；
   > 2. 对 $j\in [1,k-1]$，有 $a^{2^jq}\equiv n-1\mod n$，则很可能为素数；
   > 3. 通过上述判断仍无法确定的判断为合数。

### 项目特色

1. 使用 Rust 开发
2. 能够多线程加速运算，性能过得去
3. 密钥可以储存为类似 OpenSSH 的格式（实际上不能兼容），便于保管
4. 提供密钥检测等功能
5. 可通过管道传递加密解密数据
6. 加密和解密有进度条显示
